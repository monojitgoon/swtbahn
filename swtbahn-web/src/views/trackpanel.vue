<template>
  <div class="col-xs-12 col-md-12">
    <card header-text="Trackboard">
      <div class="card-body card-block">
        <svg
          id="track-master"
          viewBox="0 0 700 300"
          style="border: black solid; border-style: dotted"
        >
          <marker
            id="triangle"
            viewBox="0 0 10 10"
            refX="1"
            refY="5"
            markerUnits="strokeWidth"
            markerWidth="3"
            markerHeight="3"
            orient="auto"
          >
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#f00"></path>
          </marker>
          <defs>
            <circle id="circleid" cx="10" cy="10" r="10"></circle>
          </defs>
          <g>
            <!-- vertical -->
            <path stroke="green" stroke-width=".2" d="M10 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M10 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M20 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M30 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M40 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M50 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M60 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M70 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M80 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M90 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M100 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M110 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M120 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M130 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M140 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M150 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M160 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M170 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M180 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M190 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M200 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M210 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M220 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M230 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M240 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M250 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M260 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M270 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M280 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M290 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M300 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M310 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M320 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M330 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M340 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M350 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M360 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M370 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M380 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M390 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M400 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M410 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M420 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M430 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M440 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M450 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M460 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M470 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M480 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M490 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M500 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M510 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M520 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M530 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M540 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M550 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M560 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M570 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M580 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M590 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M600 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M610 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M620 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M630 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M640 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M650 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M660 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M670 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M680 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M690 0 V300"></path>
            <path stroke="green" stroke-width=".2" d="M700 0 V300"></path>

            <!-- horizontal -->
            <path stroke="green" stroke-width=".2" d="M0 10 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 20 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 30 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 40 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 50 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 60 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 70 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 80 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 90 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 100 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 110 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 120 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 130 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 140 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 150 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 160 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 170 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 180 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 190 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 200 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 210 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 220 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 230 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 240 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 250 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 260 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 270 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 280 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 290 H700"></path>
            <path stroke="green" stroke-width=".2" d="M0 300 H700"></path>
          </g>

          <!-- Track -->
          <path
            id="seg10"
            stroke="black"
            stroke-width="3"
            stroke-linecap="round"
            fill="none"
            d="M135 265  C135 265 -80 150 150 20  H220"
            marker-end="url(#triangle)"
          ></path>

          <path
            id="seg9"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M220 20 H280"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg8"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M280 20 H340"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg8-reverse"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M310 20 Q310 20 280 37"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg7"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M340 20 H400"
            marker-end="url(#triangle)"
          ></path>

          <path
            id="seg6"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M400 20 H540 C540 20 630 40 650 80"
            marker-end="url(#triangle)"
          ></path>

          <path
            id="seg5"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M650 80 C650 80 658 100 658 142"
            marker-end="url(#triangle)"
          ></path>

          <path
            id="seg4"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M658 142 C658 142 655 180 640 220"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg3"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M640 220 C640 220 600 280 550 280"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg2"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M550 280 H280"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg1"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M280 280 H245"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg12"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M245 280 H205"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg11"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M205 280 C150 280 165 280 135 265"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg16"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M644 210 C644 210 625 250 570 265"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg15"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M570 265 C570 265 570 265 320 265"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg14"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M320 265 H290"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg13"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M290 265 H235"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg13-reverse"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M270 265 Q270 265 245 280"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg21"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M235 265 H180"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg21-reverse"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M200 265 Q200 265 220 250"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg20"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M180 265 Q160 265 138 248"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg19"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M138 248 C138 248 -40 155 140 45 "
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg18"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M140 45 Q148 35 216 37"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg17"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M216 37 H280"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg27"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M280 37 H335"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg28"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M335 37 Q400 32 570 80"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg29"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M570 80 Q570 80 610 95"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg26"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M180 250 H220"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg22"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M220 250 H270"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg23"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M270 250 H290"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg24"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M290 250 H520"
            marker-end="url(#triangle)"
          ></path>
          <path
            id="seg25"
            stroke="black"
            stroke-width="3"
            fill="none"
            d="M520 250 H550"
            marker-end="url(#triangle)"
          ></path>
        </svg>
      </div>
    </card>
  </div>
</template>

<script>
import { mapState, mapActions } from "vuex";
import appConfig from "../../config/appConfig";
import img from "../images/logo2.png";

export default {
  name: "trackpanel",
  data() {
    return {
      trainobj: null
    };
  },
  components: {},
  computed: {
    ...mapState({
      system: state => state.system,
      monitor: state => state.monitor
    })
  },
  beforeDestroy() {
    clearInterval(this.system.systemTrackPanelRequestInterval);
  },
  mounted() {
    setTimeout(
      function() {
        this.GetSegmentsArray();
        this.RunSVG();
      }.bind(this),
      5000
    );
    this.system.systemTrackPanelRequestInterval = setInterval(() => {
      this.GetSegmentsArray();
      this.RunSVG();
    }, appConfig.system_trackpanel_RequestInterval);
  },
  methods: {
    ...mapActions("monitor", ["GetSegmentsArray", "GetTrainStateArray"]),
    RunSVG() {
      var currentseg = null;
      var currentTrain = null;
      var occupiedCount = 0;
      Object.keys(this.monitor.segmentArray).forEach(key => {
        const segmentid = this.monitor.segmentArray[key]["segmentid"];
        const occupied = this.monitor.segmentArray[key]["occupied"];
        const trainid = this.monitor.segmentArray[key]["trains"];
        if (
          currentseg != segmentid &&
          occupied === "yes" &&
          trainid != null &&
          !trainid.includes(",") &&
          currentTrain != trainid
        ) {
          currentTrain = trainid;
          occupiedCount++;

          this.GetTrainStateArray(currentTrain);
          const dccspeed = this.monitor.trainstateArray[0]["dccspeed"];
          const direction = this.monitor.trainstateArray[0]["direction"];

          if (occupiedCount === 1 && dccspeed > 0) {
            currentseg = segmentid;
            this.Svghandler(
              currentseg,
              dccspeed,
              direction === "forward" ? true : false
            );
          }
        }
      });
    },
    Svghandler(currentseg, currentSpeed, direction) {
      var canvas = SVG("track-master");
      var trainobj = canvas.image(img, 20, 20);
      trainobj.addClass("display");
      var path = canvas.path(
        document.getElementById(currentseg).getAttribute("d")
      );
      var animationDuration =
        appConfig.system_trackpanel_AnimationDurationDividend / currentSpeed;
      var length = path.length();
      path.fill("none").stroke({ width: 1, color: "#ccc" });

      trainobj
        .animate(animationDuration, "-")
        .during(function(pos, morph, eased) {
          var p = path.pointAt(eased * length);
          trainobj.center(p.x - 10, p.y - 10);
        })
        .reverse(direction);
      setTimeout(
        function() {
          trainobj.attr({ display: "none" });
        }.bind(this),
        animationDuration
      );
    }
  }
};
</script>
